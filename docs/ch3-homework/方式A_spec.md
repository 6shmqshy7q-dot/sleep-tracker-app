# 规约书 - 睡眠监测器

## 文档版本
- 版本号：v1.0
- 创建日期：2025-12-14
- 更新日期：2025-12-14
- 状态：草案

---

## 1. 产品概述

### 1.1 产品定义
睡眠监测器是一款面向个人消费者的智能睡眠监测应用，通过蓝牙智能设备或手机传感器采集用户睡眠数据，自动生成睡眠健康报告，并推送个性化改善建议。

### 1.2 产品目标
- **主要目标**：帮助用户了解自身睡眠质量和规律
- **次要目标**：提供科学可行的睡眠改善建议
- **商业目标**：通过订阅模式实现可持续的商业化

### 1.3 目标用户
- **主要用户**：关注睡眠健康的个人消费者
- **年龄范围**：18-65岁
- **设备条件**：拥有蓝牙智能手环/手表或智能手机

---

## 2. 功能规格

### 2.1 核心功能模块

#### 2.1.1 用户管理功能

**F001: 用户注册与登录**
- **功能描述**：支持手机号/邮箱注册登录
- **输入**：手机号/邮箱、密码
- **输出**：注册成功/失败提示，登录状态
- **约束**：
  - 手机号格式验证
  - 密码强度要求（至少8位，包含字母和数字）
  - 同一手机号/邮箱只能注册一个账户
- **异常处理**：重复注册、网络异常、验证码错误

**F002: 用户资料管理**
- **功能描述**：管理用户基本信息
- **输入**：姓名、年龄、身高、体重、设备型号
- **输出**：资料更新结果
- **约束**：
  - 年龄范围：0-150岁
  - 身高范围：50-250cm
  - 体重范围：20-300kg
  - 设备型号必填
- **默认规则**：设备型号可从设备绑定时自动获取

#### 2.1.2 设备管理功能

**F003: 设备绑定**
- **功能描述**：绑定蓝牙智能设备
- **输入**：设备名称、设备型号、蓝牙地址
- **输出**：绑定成功/失败状态
- **约束**：
  - 支持蓝牙4.0及以上版本
  - 同一设备只能绑定一个用户
  - 用户可绑定多个设备
- **兼容性要求**：
  - iOS 12.0+
  - Android 8.0+
  - 支持主流蓝牙设备品牌

**F004: 设备状态监控**
- **功能描述**：实时监控设备连接状态
- **输入**：设备蓝牙信号
- **输出**：连接状态、电量信息
- **约束**：
  - 设备电量低于10%时提醒用户充电
  - 连接断开时提供重连按钮
  - 支持设备切换功能

#### 2.1.3 数据采集功能

**F005: 睡眠数据自动采集**
- **功能描述**：通过设备传感器自动采集睡眠数据
- **输入**：加速度传感器数据、心率数据（可选）
- **输出**：睡眠数据记录
- **约束**：
  - 采样频率：不低于1Hz
  - 数据精度：加速度±0.1g，心率±5bpm
  - 数据完整性：不低于95%
- **数据内容**：
  - 睡眠时长
  - 浅睡时长
  - 深睡时长
  - REM周期时长
  - 入睡时间
  - 醒来时间
  - 睡眠评分（0-100分）

**F006: 手动睡眠记录**
- **功能描述**：支持用户手动记录睡眠时间
- **输入**：入睡时间、醒来时间
- **输出**：手动睡眠记录
- **约束**：
  - 时间范围限制在24小时内
  - 不能与已有记录时间重叠
  - 可添加备注说明

#### 2.1.4 睡眠报告功能

**F007: 基础睡眠报告（免费版）**
- **功能描述**：生成基础睡眠数据查看
- **输入**：睡眠数据记录
- **输出**：睡眠报告界面
- **报告内容**：
  - 睡眠时长统计
  - 睡眠质量评分
  - 浅睡/深睡/REM时长
  - 入睡/醒来时间
- **约束**：
  - 仅显示最近30天数据
  - 不提供趋势分析
  - 不提供改善建议

**F008: 深度睡眠报告（付费版）**
- **功能描述**：生成详细的睡眠分析报告
- **输入**：睡眠数据记录（历史数据）
- **输出**：深度分析报告
- **报告内容**：
  - 睡眠时长趋势分析
  - 睡眠质量变化趋势
  - 周/月/年睡眠模式对比
  - 睡眠效率分析
  - 入睡潜伏期分析
  - 睡眠规律性评估
- **约束**：
  - 需有效付费订阅
  - 至少需要7天历史数据
  - 支持多时间段对比

#### 2.1.5 改善建议功能

**F009: 个性化睡眠建议**
- **功能描述**：基于睡眠数据生成个性化改善建议
- **输入**：睡眠数据记录、用户信息
- **输出**：改善建议列表
- **建议类型**：
  - 作息调整建议
  - 睡眠环境优化建议
  - 饮食运动建议
- **约束**：
  - 需有效付费订阅
  - 建议内容基于合作医疗机构模型
  - 每次最多生成5条建议
  - 建议有效期30天

**F010: 建议执行跟踪**
- **功能描述**：跟踪用户建议执行情况
- **输入**：用户反馈、执行状态
- **输出**：执行效果评估
- **跟踪内容**：
  - 建议执行进度
  - 执行效果评分
  - 改进效果对比

#### 2.1.6 订阅管理功能

**F011: 订阅购买**
- **功能描述**：购买付费订阅服务
- **输入**：订阅类型（日付/月付/年付）
- **输出**：订阅订单、支付链接
- **约束**：
  - 支付成功后立即生效
  - 不支持退款
  - 支持自动续费选项
- **价格策略**：
  - 日付：¥9.9/天
  - 月付：¥29.9/月
  - 年付：¥299/年（优惠16.7%）

**F012: 订阅状态管理**
- **功能描述**：管理用户订阅状态
- **输入**：订阅订单信息
- **输出**：当前订阅状态、功能权限
- **状态类型**：
  - 免费版
  - 付费版（有效）
  - 付费版（已到期）

---

## 3. 非功能规格

### 3.1 性能要求

**PERF001: 响应时间**
- 应用启动时间：≤ 3秒
- 页面切换时间：≤ 1秒
- 数据加载时间：≤ 2秒
- 报告生成时间：≤ 5秒

**PERF002: 并发性能**
- 支持1000个并发用户
- 数据采集延迟：≤ 1秒
- 数据库查询响应：≤ 500ms

**PERF003: 数据存储**
- 用户数据本地存储
- 历史数据保留：3年
- 数据备份：每日自动备份

### 3.2 可用性要求

**USAB001: 兼容性**
- iOS 12.0及以上版本
- Android 8.0及以上版本
- 支持主流蓝牙设备：
  - Apple Watch
  - 小米手环
  - 华为手环
  - 三星Galaxy Watch

**USAB002: 用户体验**
- 支持横屏和竖屏显示
- 支持深色模式
- 字体大小可调节
- 支持语音提示（可选）

**USAB003: 容错性**
- 设备断开连接时自动重连（最多3次）
- 数据传输失败时本地缓存
- 网络异常时提供离线模式

### 3.3 安全要求

**SECU001: 数据安全**
- 用户数据本地加密存储
- 数据传输采用HTTPS协议
- 支持生物识别解锁（指纹/面容）
- 数据访问日志记录

**SECU002: 隐私保护**
- 不向第三方泄露用户数据
- 数据使用范围明确告知
- 支持数据导出和删除
- 符合GDPR和个人信息保护法要求

**SECU003: 账户安全**
- 密码加密存储（SHA-256）
- 支持双因素认证
- 登录异常检测
- 账户锁定机制（连续5次失败）

---

## 4. 数据规格

### 4.1 数据模型

#### 4.1.1 用户数据表 (users)

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| id | UUID | 36 | PK, NOT NULL | 用户唯一标识 |
| name | VARCHAR | 50 | | 姓名 |
| age | INT | | CHECK (age >= 0 AND age <= 150) | 年龄 |
| height | DECIMAL | 5,2 | CHECK (height >= 50 AND height <= 250) | 身高(cm) |
| weight | DECIMAL | 5,2 | CHECK (weight >= 20 AND weight <= 300) | 体重(kg) |
| device_model | VARCHAR | 100 | NOT NULL | 设备型号 |
| created_at | TIMESTAMP | | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | | NOT NULL | 更新时间 |

#### 4.1.2 睡眠数据记录表 (sleep_records)

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| id | UUID | 36 | PK, NOT NULL | 记录唯一标识 |
| user_id | UUID | 36 | FK, NOT NULL | 用户ID |
| total_sleep | INT | | NOT NULL | 总睡眠时长(分钟) |
| light_sleep | INT | | NOT NULL | 浅睡时长(分钟) |
| deep_sleep | INT | | NOT NULL | 深睡时长(分钟) |
| rem_sleep | INT | | NOT NULL | REM时长(分钟) |
| sleep_start | TIMESTAMP | | NOT NULL | 入睡时间 |
| sleep_end | TIMESTAMP | | NOT NULL | 醒来时间 |
| sleep_score | DECIMAL | 5,2 | CHECK (sleep_score >= 0 AND sleep_score <= 100) | 睡眠评分 |
| created_at | TIMESTAMP | | NOT NULL | 创建时间 |

#### 4.1.3 订阅订单表 (subscriptions)

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| id | UUID | 36 | PK, NOT NULL | 订单唯一标识 |
| user_id | UUID | 36 | FK, NOT NULL | 用户ID |
| type | ENUM | | NOT NULL | 订阅类型(free/daily/monthly/yearly) |
| amount | DECIMAL | 10,2 | | 支付金额 |
| start_time | TIMESTAMP | | NOT NULL | 生效时间 |
| end_time | TIMESTAMP | | | 到期时间 |
| auto_renewal | BOOLEAN | | DEFAULT FALSE | 是否自动续费 |
| created_at | TIMESTAMP | | NOT NULL | 创建时间 |

#### 4.1.4 睡眠改善方案表 (improvement_plans)

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| id | UUID | 36 | PK, NOT NULL | 方案唯一标识 |
| user_id | UUID | 36 | FK, NOT NULL | 用户ID |
| sleep_record_id | UUID | 36 | FK | 关联睡眠记录ID |
| advice_type | ENUM | | NOT NULL | 建议类型 |
| advice_content | TEXT | | NOT NULL | 建议内容 |
| created_at | TIMESTAMP | | NOT NULL | 创建时间 |

### 4.2 数据关系
- users 1:N sleep_records
- users 1:N subscriptions
- users 1:N improvement_plans
- sleep_records 1:N improvement_plans (可选)

---

## 5. 接口规格

### 5.1 RESTful API规范

#### 5.1.1 基础信息
- **基础URL**：https://api.sleepmonitor.com/v1
- **认证方式**：Bearer Token (JWT)
- **数据格式**：JSON
- **字符编码**：UTF-8

#### 5.1.2 核心接口

**API001: 用户注册**
- **请求**：`POST /auth/register`
- **请求体**：
```json
{
  "phone": "13800138000",
  "password": "password123",
  "verification_code": "123456"
}
```
- **响应**：
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "user_id": "uuid",
    "token": "jwt_token"
  }
}
```

**API002: 用户登录**
- **请求**：`POST /auth/login`
- **请求体**：
```json
{
  "phone": "13800138000",
  "password": "password123"
}
```
- **响应**：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "user_id": "uuid",
    "token": "jwt_token",
    "subscription_type": "free"
  }
}
```

**API003: 获取睡眠记录**
- **请求**：`GET /users/{user_id}/sleep-records`
- **请求参数**：
  - `start_date`: 开始日期 (YYYY-MM-DD)
  - `end_date`: 结束日期 (YYYY-MM-DD)
  - `page`: 页码 (默认1)
  - `limit`: 每页数量 (默认10)
- **响应**：
```json
{
  "code": 200,
  "data": {
    "total": 30,
    "records": [
      {
        "id": "uuid",
        "total_sleep": 480,
        "light_sleep": 180,
        "deep_sleep": 180,
        "rem_sleep": 120,
        "sleep_start": "2025-12-13T22:00:00Z",
        "sleep_end": "2025-12-14T06:00:00Z",
        "sleep_score": 85.5
      }
    ]
  }
}
```

**API004: 创建睡眠记录**
- **请求**：`POST /users/{user_id}/sleep-records`
- **请求体**：
```json
{
  "total_sleep": 480,
  "light_sleep": 180,
  "deep_sleep": 180,
  "rem_sleep": 120,
  "sleep_start": "2025-12-13T22:00:00Z",
  "sleep_end": "2025-12-14T06:00:00Z"
}
```
- **响应**：
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "record_id": "uuid",
    "sleep_score": 85.5
  }
}
```

**API005: 获取睡眠建议**
- **请求**：`GET /users/{user_id}/improvement-plans`
- **请求参数**：
  - `record_id`: 睡眠记录ID (可选)
- **响应**：
```json
{
  "code": 200,
  "data": {
    "plans": [
      {
        "id": "uuid",
        "advice_type": "作息调整",
        "advice_content": "建议您每天晚上10:30上床睡觉，保持规律的作息时间"
      }
    ]
  }
}
```

**API006: 创建订阅订单**
- **请求**：`POST /users/{user_id}/subscriptions`
- **请求体**：
```json
{
  "type": "monthly",
  "auto_renewal": true
}
```
- **响应**：
```json
{
  "code": 200,
  "message": "订单创建成功",
  "data": {
    "order_id": "uuid",
    "payment_url": "https://payment.example.com/pay/xxx"
  }
}
```

### 5.2 错误处理

#### 5.2.1 错误码规范
- `200`: 成功
- `400`: 请求参数错误
- `401`: 未授权（token无效或过期）
- `403`: 权限不足（需要付费功能但未订阅）
- `404`: 资源不存在
- `500`: 服务器内部错误

#### 5.2.2 错误响应格式
```json
{
  "code": 400,
  "message": "请求参数错误",
  "errors": {
    "phone": "手机号格式不正确"
  }
}
```

---

## 6. 质量保证

### 6.1 测试要求

**TEST001: 单元测试**
- 代码覆盖率不低于80%
- 核心业务逻辑覆盖率100%
- 使用自动化测试框架

**TEST002: 集成测试**
- API接口测试
- 数据库集成测试
- 第三方服务集成测试

**TEST003: 用户验收测试**
- 功能验收测试
- 用户体验测试
- 兼容性测试

### 6.2 监控要求

**MONI001: 应用监控**
- 应用性能监控 (APM)
- 错误日志收集
- 用户行为分析

**MONI002: 业务监控**
- 用户注册转化率
- 订阅转化率
- 功能使用率统计

---

## 7. 部署要求

### 7.1 环境要求

**DEPL001: 服务器要求**
- CPU: 4核心以上
- 内存: 8GB以上
- 存储: 100GB以上 SSD
- 网络: 带宽10Mbps以上

**DEPL002: 软件要求**
- 操作系统: CentOS 7+ / Ubuntu 18.04+
- 数据库: MySQL 8.0+ / PostgreSQL 12+
- 缓存: Redis 6.0+
- Web服务器: Nginx 1.18+

### 7.2 部署策略

**DEPL003: 部署方式**
- 支持容器化部署 (Docker)
- 支持Kubernetes集群部署
- 支持蓝绿部署/灰度发布

**DEPL004: 备份策略**
- 数据库每日自动备份
- 备份保留30天
- 支持一键恢复

---

## 8. 运维要求

### 8.1 维护窗口
- 每周日凌晨2:00-4:00为系统维护时间
- 紧急维护需提前24小时通知用户

### 8.2 应急响应
- P0级故障：15分钟内响应
- P1级故障：1小时内响应
- P2级故障：4小时内响应

---

## 9. 合规要求

### 9.1 法律合规
- 遵守《个人信息保护法》
- 遵守《数据安全法》
- 遵守《网络安全法》
- 符合GDPR要求（如有欧盟用户）

### 9.2 行业标准
- 遵循医疗器械相关法规（如果适用）
- 符合健康数据管理标准
- 通过信息安全等级保护认证

---

## 10. 文档维护

### 10.1 更新记录
- v1.0 (2025-12-14)：初始版本，创建完整的产品规约书

### 10.2 相关文档
- 《现实约束 - 睡眠监测器》
- 《认知模型 - 睡眠监测器》
- 《技术架构设计文档》
- 《数据库设计文档》
- 《API接口文档》
- 《测试计划文档》

### 10.3 审批记录
- 产品负责人：待审批
- 技术负责人：待审批
- 测试负责人：待审批
- 运维负责人：待审批
- 法务负责人：待审批
- 业务负责人：待审批
